package com.expedia.content.media.processing.pipeline.util;

import com.expedia.content.media.processing.pipeline.avro.ImageMessageAvro;
import com.expedia.content.media.processing.pipeline.domain.ImageMessage;
import org.junit.Test;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

public class ImageMessageAvroUtilTest {
    @Test
    public void testImageAvroPropertyForRouterJson() throws Exception {
        String fullJson = "\n"
                + "{  \n"
                + "  \"active\":\"true\",\n"
                + "  \"domain\":\"Lodging\",\n"
                + "  \"domainId\":\"41098\",\n"
                + "  \"domainProvider\":\"EPC External User\",\n"
                + "  \"fileName\":\"41098_epc_2e84ed6.jpg\",\n"
                + "  \"fileUrl\":\"s3://ewe-cs-media-test/e2e/images/8492274_13_0013ice.jpg\",\n"
                + "  \"userId\":\"media-cloud-router\"\n"
                + "}";

        ImageMessage imageMessage = ImageMessage.parseJsonMessage(fullJson);
        ImageMessageAvro imageMessageAvro = ImageMessageAvroUtil.generateAvroMsg(imageMessage);
        assertEquals(imageMessageAvro.getActive(), "true");
        assertEquals(imageMessageAvro.getDomain(), "Lodging");
        assertEquals(imageMessageAvro.getDomainId(), "41098");
        assertEquals(imageMessageAvro.getDomainProvider(), "EPC External User");
        assertEquals(imageMessageAvro.getFileName(), "41098_epc_2e84ed6.jpg");
        assertEquals(imageMessageAvro.getFileUrl(), "s3://ewe-cs-media-test/e2e/images/8492274_13_0013ice.jpg");

    }

    @Test
    public void testImageAvroPropertyForEPCJson() throws Exception {
        String fullJson = "{  \n"
                + "  \"fileUrl\":\"https://epc-photos-prod.s3.amazonaws.com/2403877/f182d72a-4a3d-4ce6-8ce0-474b49f2767d.jpg\",\n"
                + "  \"userId\":\"ETX-SHolland11\",\n"
                + "  \"fileName\":\"Villastreet5.jpg\",\n"
                + "  \"domain\":\"Lodging\",\n"
                + "  \"domainId\":\"2403877\",\n"
                + "  \"domainProvider\":\"EPC External User\",\n"
                + "  \"domainFields\":{  \n"
                + "    \"subcategoryId\":\"91000\",\n"
                + "    \"propertyHero\":\"false\"\n"
                + "  },\n"
                + "  \"generateThumbnail\":\"false\"\n"
                + "}";
        ImageMessage imageMessage = ImageMessage.parseJsonMessage(fullJson);
        ImageMessageAvro imageMessageAvro = ImageMessageAvroUtil.generateAvroMsg(imageMessage);
        assertEquals(imageMessageAvro.getUserId(), ("ETX-SHolland11"));
        assertTrue(imageMessageAvro.getDomainFields().toString().contains("91000"));
        assertTrue(imageMessageAvro.getDomainFields().toString().contains("false"));

    }

    @Test
    public void testImageAvroLogEntry() throws Exception {
        String fullJson = "{  \n"
                + "   \"clientId\":\"EPC\",\n"
                + "   \"userId\":\"etx-margaritaaceves\",\n"
                + "   \"requestId\":\"6cfb0cdb-ad43-4d4b-924f-689ad0afdbea\",\n"
                + "   \"mediaGuid\":\"e52c5164-e0e8-4101-8627-38efa8bdb1ab\",\n"
                + "   \"fileUrl\":\"https:\\/\\/epc-photos-prod.s3.amazonaws.com\\/28109\\/48ae27fd-4c18-40f3-8bf0-6313f43e08c4.jpg\",\n"
                + "   \"fileName\":\"28109_EPCExternalUser_e52c5164-e0e8-4101-8627-38efa8bdb1ab.jpg\",\n"
                + "   \"rotation\":null,\n"
                + "   \"active\":\"true\",\n"
                + "   \"generateThumbnail\":\"false\",\n"
                + "   \"genOutput\":null,\n"
                + "   \"rejectedOutput\":null,\n"
                + "   \"callback\":null,\n"
                + "   \"comment\":null,\n"
                + "   \"hidden\":\"false\",\n"
                + "   \"providedName\":\"DSC00113-1 72DPI.jpg\",\n"
                + "   \"failedReason\":null,\n"
                + "   \"retryCount\":null,\n"
                + "   \"domain\":\"Lodging\",\n"
                + "   \"domainId\":\"28109\",\n"
                + "   \"domainProvider\":\"EPC External User\",\n"
                + "   \"domainDerivativeCategory\":null,\n"
                + "   \"domainFields\":{  \n"
                + "      \"subcategoryId\":\"23000\",\n"
                + "      \"propertyHero\":\"false\",\n"
                + "      \"rooms\":[  \n"
                + "         {  \n"
                + "            \"roomId\":\"11309080\",\n"
                + "            \"roomHero\":\"false\"\n"
                + "         },\n"
                + "         {  \n"
                + "            \"roomId\":\"5886507\",\n"
                + "            \"roomHero\":\"false\"\n"
                + "         },\n"
                + "         {  \n"
                + "            \"roomId\":\"5886575\",\n"
                + "            \"roomHero\":\"false\"\n"
                + "         },\n"
                + "         {  \n"
                + "            \"roomId\":\"5886616\",\n"
                + "            \"roomHero\":\"false\"\n"
                + "         }\n"
                + "      ]\n"
                + "   },\n"
                + "   \"derivatives\":[  \n"
                + "      {  \n"
                + "         \"fileSize\":16272,\n"
                + "         \"width\":350,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_b.jpg\",\n"
                + "         \"type\":\"b\",\n"
                + "         \"height\":196\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":8149,\n"
                + "         \"width\":255,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_l.jpg\",\n"
                + "         \"type\":\"l\",\n"
                + "         \"height\":144\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":5745,\n"
                + "         \"width\":200,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_s.jpg\",\n"
                + "         \"type\":\"s\",\n"
                + "         \"height\":112\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":1785,\n"
                + "         \"width\":70,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_t.jpg\",\n"
                + "         \"type\":\"t\",\n"
                + "         \"height\":70\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":4041,\n"
                + "         \"width\":160,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_e.jpg\",\n"
                + "         \"type\":\"e\",\n"
                + "         \"height\":90\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":2418,\n"
                + "         \"width\":90,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_n.jpg\",\n"
                + "         \"type\":\"n\",\n"
                + "         \"height\":90\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":4772,\n"
                + "         \"width\":140,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_g.jpg\",\n"
                + "         \"type\":\"g\",\n"
                + "         \"height\":140\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":7410,\n"
                + "         \"width\":180,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_d.jpg\",\n"
                + "         \"type\":\"d\",\n"
                + "         \"height\":180\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":32116,\n"
                + "         \"width\":500,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_y.jpg\",\n"
                + "         \"type\":\"y\",\n"
                + "         \"height\":281\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":124166,\n"
                + "         \"width\":1000,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_z.jpg\",\n"
                + "         \"type\":\"z\",\n"
                + "         \"height\":562\n"
                + "      },\n"
                + "      {  \n"
                + "         \"fileSize\":432667,\n"
                + "         \"width\":2000,\n"
                + "         \"location\":\"s3:\\/\\/ewe-cs-media-test\\/test\\/derivative\\/lodging\\/1000000\\/50000\\/41100\\/41098\\/65cd5b12_w.jpg\",\n"
                + "         \"type\":\"w\",\n"
                + "         \"height\":1125\n"
                + "      }\n"
                + "   ],\n"
                + "   \"fingerprints\":[  \n"
                + "      {  \n"
                + "         \"values\":[  \n"
                + "            \"1000101101011001100101101110110100001100000001101\"\n"
                + "         ],\n"
                + "         \"algorithm\":\"pHash\"\n"
                + "      },\n"
                + "      {  \n"
                + "         \"values\":[  \n"
                + "            \"E081F37D5077EFF216C77BDA352470193C6B3BFD\"\n"
                + "         ],\n"
                + "         \"algorithm\":\"SHA1\"\n"
                + "      }\n"
                + "   ],\n"
                + "   \"fileSize\":472318,\n"
                + "   \"width\":6544,\n"
                + "   \"height\":3680,\n"
                + "   \"metadataDetails\":{  \n"
                + "      \"APP14Flags0\":\"Encoded with Blend=1 downsampling\",\n"
                + "      \"APP14Flags1\":\"(none)\",\n"
                + "      \"Aperture\":\"1.8\",\n"
                + "      \"ApplicationRecordVersion\":\"63736\",\n"
                + "      \"BitsPerSample\":\"8\",\n"
                + "      \"Caption-Abstract\":\"\",\n"
                + "      \"CodedCharacterSet\":\"UTF8\",\n"
                + "      \"ColorComponents\":\"3\",\n"
                + "      \"ColorMode\":\"RGB\",\n"
                + "      \"ColorSpace\":\"Uncalibrated\",\n"
                + "      \"ColorTransform\":\"YCbCr\",\n"
                + "      \"Colorspace\":\"sRGB\",\n"
                + "      \"ComponentsConfiguration\":\"Y, Cb, Cr, -\",\n"
                + "      \"CompressedBitsPerPixel\":\"2\",\n"
                + "      \"Compression\":\"JPEG (old-style)\",\n"
                + "      \"Contrast\":\"Normal\",\n"
                + "      \"CreateDate\":\"2016\",\n"
                + "      \"CreatorTool\":\"Adobe Photoshop CC (Windows)\",\n"
                + "      \"CurrentIPTCDigest\":\"b8d9a3a73a7b08c5bbae6e535daf79b3\",\n"
                + "      \"CustomRendered\":\"Normal\",\n"
                + "      \"DCTEncodeVersion\":\"100\",\n"
                + "      \"DateCreated\":\"2016\",\n"
                + "      \"DateTimeCreated\":\"2016\",\n"
                + "      \"DateTimeOriginal\":\"2016\",\n"
                + "      \"Depth\":\"8-bit\",\n"
                + "      \"DerivedFromDocumentID\":\"xmp.did\",\n"
                + "      \"DerivedFromInstanceID\":\"xmp.iid\",\n"
                + "      \"DerivedFromOriginalDocumentID\":\"xmp.did\",\n"
                + "      \"Description\":\"\",\n"
                + "      \"DigitalZoomRatio\":\"1\",\n"
                + "      \"Directory\":\"\\/tmp\\/work-folder-2173700853116911406\",\n"
                + "      \"DisplayedUnitsX\":\"inches\",\n"
                + "      \"DisplayedUnitsY\":\"inches\",\n"
                + "      \"DocumentID\":\"xmp.did\",\n"
                + "      \"EncodingProcess\":\"Baseline DCT, Huffman coding\",\n"
                + "      \"ExifByteOrder\":\"Little-endian (Intel, II)\",\n"
                + "      \"ExifImageHeight\":\"3680\",\n"
                + "      \"ExifImageWidth\":\"6544\",\n"
                + "      \"ExifToolVersion\":\"10.00\",\n"
                + "      \"ExifVersion\":\"0230\",\n"
                + "      \"ExposureCompensation\":\"0\",\n"
                + "      \"ExposureMode\":\"Auto\",\n"
                + "      \"ExposureProgram\":\"Program AE\",\n"
                + "      \"ExposureTime\":\"1\\/60\",\n"
                + "      \"FNumber\":\"1.8\",\n"
                + "      \"FileAccessDate\":\"2016\",\n"
                + "      \"FileInodeChangeDate\":\"2016\",\n"
                + "      \"FileModifyDate\":\"2016\",\n"
                + "      \"FileName\":\"e52c5164-e0e8-4101-8627-38efa8bdb1ab.jpg\",\n"
                + "      \"FilePermissions\":\"rw-r--r--\",\n"
                + "      \"FileSize\":\"461 kB\",\n"
                + "      \"FileSource\":\"Digital Camera\",\n"
                + "      \"FileType\":\"JPEG\",\n"
                + "      \"FileTypeExtension\":\"jpg\",\n"
                + "      \"Flash\":\"Auto, Did not fire\",\n"
                + "      \"FlashpixVersion\":\"0100\",\n"
                + "      \"FocalLength\":\"3.8 mm\",\n"
                + "      \"FocalLength35efl\":\"3.8 mm\",\n"
                + "      \"Format\":\"image\\/jpeg\",\n"
                + "      \"Gamma\":\"0.454545\",\n"
                + "      \"Geometry\":\"6544x3680+0+0\",\n"
                + "      \"GlobalAltitude\":\"30\",\n"
                + "      \"GlobalAngle\":\"30\",\n"
                + "      \"HistoryAction\":\"created, converted, saved, saved, converted, derived, saved\",\n"
                + "      \"HistoryChanged\":\"\\/, \\/, \\/\",\n"
                + "      \"HistoryInstanceID\":\"xmp.iid\",\n"
                + "      \"HistoryWhen\":\"2016\",\n"
                + "      \"IPTCDigest\":\"b8d9a3a73a7b08c5bbae6e535daf79b3\",\n"
                + "      \"Image\":\"\\/tmp\\/work-folder-2173700853116911406\\/e52c5164-e0e8-4101-8627-38efa8bdb1ab.jpg\",\n"
                + "      \"ImageDescription\":\"\",\n"
                + "      \"ImageHeight\":\"3680\",\n"
                + "      \"ImageSize\":\"6544x3680\",\n"
                + "      \"ImageWidth\":\"6544\",\n"
                + "      \"InstanceID\":\"xmp.iid\",\n"
                + "      \"Interlace\":\"None\",\n"
                + "      \"LensInfo\":\"?mm f\\/1.8-3.4\",\n"
                + "      \"LightSource\":\"Other\",\n"
                + "      \"MIMEType\":\"image\\/jpeg\",\n"
                + "      \"Make\":\"SONY\",\n"
                + "      \"MaxApertureValue\":\"1.8\",\n"
                + "      \"Megapixels\":\"24.1\",\n"
                + "      \"MetadataDate\":\"2016\",\n"
                + "      \"MeteringMode\":\"Multi-segment\",\n"
                + "      \"Mime type\":\"image\\/jpeg\",\n"
                + "      \"Model\":\"HXR-NX30N\",\n"
                + "      \"ModifyDate\":\"2016\",\n"
                + "      \"Orientation\":\"Horizontal (normal)\",\n"
                + "      \"OriginalDocumentID\":\"xmp.did\",\n"
                + "      \"PhotoshopFormat\":\"Standard\",\n"
                + "      \"PhotoshopQuality\":\"1\",\n"
                + "      \"PhotoshopThumbnail\":\"(Binary data 4215 bytes, use -b option to extract)\",\n"
                + "      \"PrintIMVersion\":\"0300\",\n"
                + "      \"ProgressiveScans\":\"3 Scans\",\n"
                + "      \"Quality\":\"81\",\n"
                + "      \"ResolutionUnit\":\"inches\",\n"
                + "      \"Saturation\":\"Normal\",\n"
                + "      \"SceneCaptureType\":\"Standard\",\n"
                + "      \"SceneType\":\"Directly photographed\",\n"
                + "      \"Sharpness\":\"Normal\",\n"
                + "      \"ShutterSpeed\":\"1\\/60\",\n"
                + "      \"Software\":\"Adobe Photoshop CC (Windows)\",\n"
                + "      \"ThumbnailImage\":\"(Binary data 4215 bytes, use -b option to extract)\",\n"
                + "      \"ThumbnailLength\":\"4215\",\n"
                + "      \"ThumbnailOffset\":\"966\",\n"
                + "      \"TimeCreated\":\"12\",\n"
                + "      \"UserComment\":\"\",\n"
                + "      \"WhiteBalance\":\"Manual\",\n"
                + "      \"XMPToolkit\":\"Adobe XMP Core 5.5-c014 79.151481, 2013\\/03\\/13-12\",\n"
                + "      \"XResolution\":\"72\",\n"
                + "      \"YCbCrPositioning\":\"Co-sited\",\n"
                + "      \"YCbCrSubSampling\":\"YCbCr4\",\n"
                + "      \"YResolution\":\"72\"\n"
                + "   },\n"
                + "   \"logEntries\":[  \n"
                + "      {  \n"
                + "         \"activity\":\"Reception\",\n"
                + "         \"appName\":\"cs-media-service\",\n"
                + "         \"activityTime\":1475172720666\n"
                + "      },\n"
                + "      {  \n"
                + "         \"activity\":\"MediaMessageReceived\",\n"
                + "         \"appName\":\"cs-media-service\",\n"
                + "         \"activityTime\":1475172721129\n"
                + "      },\n"
                + "      {  \n"
                + "         \"activity\":\"CollectorStart\",\n"
                + "         \"appName\":\"cs-media-collector-service\",\n"
                + "         \"activityTime\":1475172729594\n"
                + "      },\n"
                + "      {  \n"
                + "         \"activity\":\"CollectorStart\",\n"
                + "         \"appName\":\"cs-media-collector-service\",\n"
                + "         \"activityTime\":1475172729595\n"
                + "      },\n"
                + "      {  \n"
                + "         \"activity\":\"CollectorDownload\",\n"
                + "         \"appName\":\"cs-media-collector-service\",\n"
                + "         \"activityTime\":1475172730559\n"
                + "      },\n"
                + "      {  \n"
                + "         \"activity\":\"CollectorValidation\",\n"
                + "         \"appName\":\"cs-media-collector-service\",\n"
                + "         \"activityTime\":1475172732125\n"
                + "      },\n"
                + "      {  \n"
                + "         \"activity\":\"SourceArchived\",\n"
                + "         \"appName\":\"cs-media-collector-service\",\n"
                + "         \"activityTime\":1475172735149\n"
                + "      }\n"
                + "   ]\n"
                + "}";
            ImageMessage imageMessage = ImageMessage.parseJsonMessage(fullJson);
            ImageMessageAvro imageMessageAvro = ImageMessageAvroUtil.generateAvroMsg(imageMessage);
            assertTrue(imageMessageAvro.getLogEntries().size() == 7);
            assertTrue(imageMessageAvro.getFingerprints().size() == 2);
            assertTrue(imageMessageAvro.getDerivatives().size() == 11);

    }
}
